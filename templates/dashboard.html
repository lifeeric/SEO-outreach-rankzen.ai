{% extends "base.html" %}

{% block title %}Dashboard - RankZen Control Panel{% endblock %}
{% block header %}Dashboard{% endblock %}

{% block content %}
<style>
  .bot-control-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .bot-status-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
  }
  .bot-actions button {
    margin-left: 0.5rem;
  }
  .bot-metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
  }
  .metric-card {
    background: var(--panel);
    border-radius: var(--radius);
    padding: 1rem;
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
  }
  .metric-card strong {
    display: block;
    color: var(--muted);
    font-size: 0.85rem;
    margin-bottom: 0.4rem;
  }
  .metric-value {
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--brand);
  }
  .metric-subtext {
    margin-top: 0.25rem;
    color: var(--muted);
    font-size: 0.75rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
</style>

<div class="card">
  <div class="bot-control-header">
    <div>
      <h3 style="margin-bottom: 0.5rem;">ü§ñ Bot Control</h3>
      <div class="bot-status-pill">
        <span>Status:</span>
        <span id="bot-status" style="color: var(--error);">Stopped</span>
      </div>
    </div>
    <div class="bot-actions">
      <button id="start-bot-btn" onclick="startBot()" class="btn">‚ñ∂Ô∏è Start Bot</button>
      <button id="stop-bot-btn" onclick="stopBot()" class="btn btn-danger" style="display: none;">‚èπÔ∏è Stop Bot</button>
    </div>
  </div>
  <div class="bot-metrics-grid">
    <div class="metric-card">
      <strong>Total Discovered</strong>
      <div class="metric-value" id="total-discovered">0</div>
    </div>
    <div class="metric-card">
      <strong>Form Contacts Found</strong>
      <div class="metric-value" id="forms-found">0</div>
    </div>
    <div class="metric-card">
      <strong>Daily Activity</strong>
      <div class="metric-value" id="daily-summary">0 / 0</div>
      <div class="metric-subtext">Audits / Outreach</div>
    </div>
    <div class="metric-card">
      <strong>Uptime (hrs)</strong>
      <div class="metric-value" id="uptime">0.0</div>
    </div>
  </div>
</div>

<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-number" id="total-leads">0</div>
    <div class="stat-label">Total Leads</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" id="audited-leads">0</div>
    <div class="stat-label">Leads Audited</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" id="sent-leads">0</div>
    <div class="stat-label">Leads Contacted</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" id="responded-leads">0</div>
    <div class="stat-label">Responses</div>
  </div>
</div>

<div class="card">
  <h3>üìß Send Test Email</h3>
  <div id="test-email-result" style="margin-bottom: 1rem; display: none;"></div>
  <div style="display: flex; gap: 1rem; align-items: center;">
    <input type="email" id="test-email-address" placeholder="Enter recipient email address" style="flex: 1; padding: 0.75rem; background: var(--panel); border: 1px solid var(--muted); border-radius: var(--radius); color: var(--text); font-family: inherit;">
    <button onclick="sendTestEmail()" class="btn" id="test-email-btn">Test Email</button>
  </div>
</div>

<div class="card">
  <h3>üìù Recent Activity</h3>
  <div id="activity-log"></div>
</div>

<script>
let statusCheckInterval;
let dashboardUpdateInterval;

// Function to update dashboard data
function updateDashboard() {
  fetch('/admin/api/dashboard-data')
    .then(response => response.json())
    .then(data => {
      // Update lead counts
      document.getElementById('total-leads').textContent = data.total_leads;
      document.getElementById('audited-leads').textContent = data.audited_leads;
      document.getElementById('sent-leads').textContent = data.sent_leads;
      document.getElementById('responded-leads').textContent = data.responded_leads;
      
      // Update bot status
      const botStatusElement = document.getElementById('bot-status');
      botStatusElement.textContent = data.bot_running ? 'Running' : 'Stopped';
      botStatusElement.style.color = data.bot_running ? 'var(--success)' : 'var(--error)';
      
      // Show appropriate bot control buttons
      document.getElementById('start-bot-btn').style.display = data.bot_running ? 'none' : 'inline-block';
      document.getElementById('stop-bot-btn').style.display = data.bot_running ? 'inline-block' : 'none';
      
      // Update bot stats
      if (data.bot_stats) {
        document.getElementById('total-discovered').textContent = data.bot_stats.total_sites_discovered ?? 0;
        document.getElementById('forms-found').textContent = data.bot_stats.total_contact_forms_found ?? 0;
        const dailyAudits = data.bot_stats.daily_audits ?? 0;
        const dailyOutreach = data.bot_stats.daily_outreach ?? 0;
        document.getElementById('daily-summary').textContent = `${dailyAudits} / ${dailyOutreach}`;
        const uptimeHours = Number(data.bot_stats.uptime_hours || 0);
        document.getElementById('uptime').textContent = uptimeHours.toFixed(1);
      }
      
      // Update activity log
      const activityLogElement = document.getElementById('activity-log');
      activityLogElement.innerHTML = '';
      
      data.recent_logs.forEach(log => {
        const logElement = document.createElement('div');
        logElement.className = `log-${log.level.toLowerCase()}`;
        logElement.style.padding = '0.5rem';
        logElement.style.borderBottom = '1px solid var(--panel)';
        
        const timeElement = document.createElement('small');
        timeElement.style.color = 'var(--muted)';
        timeElement.textContent = new Date(log.timestamp).toLocaleTimeString();
        
        const messageElement = document.createElement('span');
        messageElement.style.marginLeft = '1rem';
        messageElement.textContent = log.message;
        
        logElement.appendChild(timeElement);
        logElement.appendChild(messageElement);
        
        if (log.category !== 'general') {
          const categoryElement = document.createElement('small');
          categoryElement.style.color = 'var(--brand)';
          categoryElement.style.marginLeft = '1rem';
          categoryElement.textContent = `[${log.category}]`;
          logElement.appendChild(categoryElement);
        }
        
        activityLogElement.appendChild(logElement);
      });
    })
    .catch(error => console.error('Dashboard update error:', error));
}

function sendTestEmail() {
  const emailInput = document.getElementById('test-email-address');
  const email = emailInput.value.trim();
  const resultDiv = document.getElementById('test-email-result');
  const sendButton = document.getElementById('test-email-btn');
  
  // Validate email
  if (!email) {
    showTestEmailResult('Please enter an email address', 'error');
    return;
  }
  
  // Simple email validation
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showTestEmailResult('Please enter a valid email address', 'error');
    return;
  }
  
  // Disable button and show loading state
  sendButton.disabled = true;
  sendButton.textContent = 'Sending...';
  resultDiv.style.display = 'none';
  
  // Send test email
  fetch('/admin/send-test-email', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ email: email })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showTestEmailResult('Test email sent successfully!', 'success');
      emailInput.value = ''; // Clear the input
    } else {
      showTestEmailResult('Failed to send test email: ' + (data.error || 'Unknown error'), 'error');
    }
  })
  .catch(error => {
    showTestEmailResult('Error sending test email: ' + error, 'error');
  })
  .finally(() => {
    // Re-enable button
    sendButton.disabled = false;
    sendButton.textContent = 'Test Email';
  });
}

function showTestEmailResult(message, type) {
  const resultDiv = document.getElementById('test-email-result');
  resultDiv.textContent = message;
  resultDiv.className = type === 'success' ? 'alert alert-success' : 'alert alert-error';
  resultDiv.style.display = 'block';
  
  // Auto-hide success messages after 5 seconds
  if (type === 'success') {
    setTimeout(() => {
      resultDiv.style.display = 'none';
    }, 5000);
  }
}

function startBot() {
  fetch('/admin/bot/start', { method: 'POST' })
    .then(response => response.json())
    .then(() => updateDashboard())
    .catch(error => console.error('Start bot error:', error));
}

function stopBot() {
  fetch('/admin/bot/stop', { method: 'POST' })
    .then(response => response.json())
    .then(() => updateDashboard())
    .catch(error => console.error('Stop bot error:', error));
}

function initDashboard() {
  updateDashboard();
  dashboardUpdateInterval = setInterval(updateDashboard, 15000);
}

window.addEventListener('DOMContentLoaded', initDashboard);
</script>
{% endblock %}
