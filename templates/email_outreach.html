{% extends "base.html" %}

{% block title %}Email Outreach - RankZen Control Panel{% endblock %}
{% block header %}Email Outreach{% endblock %}

{% block content %}
<style>
  .btn-small {
    background: var(--panel);
    color: var(--text);
    border: 1px solid var(--muted);
    border-radius: 12px;
    padding: 0.35rem 0.75rem;
    font-size: 0.85rem;
    cursor: pointer;
  }
  .btn-small:hover {
    background: var(--brand);
    color: #041019;
  }
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(7, 11, 25, 0.75);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }
  .modal-overlay.active { display: flex; }
  .modal-content {
    background: var(--card);
    box-shadow: var(--shadow);
    border-radius: var(--radius);
    padding: 2rem;
    max-width: 640px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal-close {
    float: right;
    cursor: pointer;
    color: var(--muted);
  }
  .email-meta {
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 1rem;
  }
  .email-body {
    background: var(--panel);
    padding: 1rem;
    border-radius: var(--radius);
    margin-bottom: 1rem;
  }
  .email-body pre {
    white-space: pre-wrap;
    margin: 0;
  }
</style>

<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-number">{{ total_emails_sent }}</div>
    <div class="stat-label">Total Emails Sent</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ outreach_emails }}</div>
    <div class="stat-label">Outreach Emails</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ followup_emails }}</div>
    <div class="stat-label">Follow-up Emails</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ form_submissions }}</div>
    <div class="stat-label">Form Submissions</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ pending_followups }}</div>
    <div class="stat-label">Pending Follow-ups</div>
  </div>
</div>

<div class="card">
  <h3>üìä Provider Health</h3>
  <div style="display:flex; flex-wrap:wrap; gap:1.5rem;">
    <div>
      <strong>Provider:</strong> {{ email_status.provider }}
    </div>
    <div>
      <strong>Connected:</strong>
      <span style="color: {{ 'var(--success)' if email_status.connected else 'var(--error)' }};">
        {{ 'Yes' if email_status.connected else 'No' }}
      </span>
    </div>
    <div>
      <strong>Last Event:</strong> {{ email_status.last_event }}
      {% if email_status.last_event_time %}
        <small style="color: var(--muted);">({{ email_status.last_event_time.strftime('%Y-%m-%d %H:%M') }})</small>
      {% endif %}
    </div>
    <div>
      <strong>7-day Sent:</strong> {{ email_status.sent_7d }}
    </div>
    <div>
      <strong>7-day Delivered:</strong> {{ email_status.delivered_7d }}
    </div>
    <div>
      <strong>7-day Bounced:</strong> {{ email_status.bounced_7d }}
    </div>
    <div>
      <strong>7-day Complaints:</strong> {{ email_status.complaints_7d }}
    </div>
    <div>
      <strong>Last Follow-up Sweep:</strong>
      {% if email_status.last_followup_check %}
        {{ email_status.last_followup_check.strftime('%Y-%m-%d %H:%M') }}
      {% else %}
        Never
      {% endif %}
    </div>
  </div>
</div>

<div class="card">
  <h3>üìß Email Outreach Control</h3>
  <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
    <div>
      <strong>Follow-up Check:</strong>
      <span>Last run: {{ last_followup_check or 'Never' }}</span>
    </div>
    <div style="margin-left: auto;">
      <button onclick="checkFollowUps()" class="btn">üîç Check Follow-ups</button>
    </div>
  </div>
  
  <p>System automatically checks for follow-ups every 3 hours. Click the button above to manually trigger a check.</p>
</div>
<div id="email-modal" class="modal-overlay">
  <div class="modal-content">
    <span class="modal-close" onclick="closeEmailModal()">‚úñ</span>
    <h3 id="modal-subject">Email Preview</h3>
    <div class="email-meta">
      <div><strong>Recipient:</strong> <span id="modal-recipient"></span></div>
      <div><strong>Domain:</strong> <span id="modal-domain"></span></div>
      <div><strong>Type:</strong> <span id="modal-type"></span></div>
      <div><strong>Status:</strong> <span id="modal-status"></span></div>
      <div><strong>Sent:</strong> <span id="modal-sent-at"></span></div>
    </div>
    <div class="email-body">
      <h4>HTML</h4>
      <div id="modal-body-html"></div>
    </div>
    <div class="email-body">
      <h4>Text</h4>
      <pre id="modal-body-text"></pre>
    </div>
    <div class="email-body">
      <h4>Context</h4>
      <pre id="modal-context"></pre>
    </div>
  </div>
</div>

{% if recent_events %}
<div class="card">
  <h3>üì° Recent Email Events</h3>
  <table>
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Recipient</th>
        <th>Type</th>
        <th>Status</th>
        <th>Reason</th>
      </tr>
    </thead>
    <tbody>
      {% for event in recent_events %}
      <tr>
        <td>{{ event.occurred_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td>{{ event.recipient_email or 'N/A' }}</td>
        <td>{{ event.event_type or 'N/A' }}</td>
        <td>{{ event.status or 'N/A' }}</td>
        <td>{{ event.reason or '‚Äî' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<div class="card">
  <h3>üìã Recent Email Activity</h3>
  {% if recent_emails %}
  <table>
    <thead>
      <tr>
        <th>Recipient</th>
        <th>Domain</th>
        <th>Type</th>
        <th>Status</th>
        <th>Sent At</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for email in recent_emails %}
      <tr>
        <td>{{ email.recipient_email }}</td>
        <td>{{ email.domain }}</td>
        <td>
          <span class="status-badge status-{% if email.campaign_type == 'outreach' %}sent{% else %}audited{% endif %}">
            {{ email.campaign_type.title() }}
          </span>
        </td>
        <td>
          <span class="status-badge status-{% if email.status == 'sent' %}sent{% else %}audited{% endif %}">
            {{ email.status.title() }}
          </span>
        </td>
        <td>{{ email.sent_at.strftime('%Y-%m-%d %H:%M') if email.sent_at else 'N/A' }}</td>
        <td>
          <button class="btn-small" onclick="openEmailModal(this)" data-email='{{ {"recipient": email.recipient_email, "domain": email.domain, "campaign_type": email.campaign_type, "status": email.status, "subject": email.subject, "body_html": email.body_html, "body_text": email.body_text, "context": email.context, "sent_at": email.sent_at.strftime('%Y-%m-%d %H:%M') if email.sent_at else 'N/A' } | tojson | safe }}'>View</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No email activity found.</p>
  {% endif %}
</div>

<script>
function openEmailModal(button) {
  try {
    const data = JSON.parse(button.dataset.email);
    document.getElementById('modal-subject').textContent = data.subject || 'Email Preview';
    document.getElementById('modal-recipient').textContent = data.recipient || 'N/A';
    document.getElementById('modal-domain').textContent = data.domain || 'N/A';
    document.getElementById('modal-type').textContent = data.campaign_type || 'N/A';
    document.getElementById('modal-status').textContent = data.status || 'N/A';
    document.getElementById('modal-sent-at').textContent = data.sent_at || 'N/A';
    document.getElementById('modal-body-html').innerHTML = data.body_html || '<em>No HTML body available.</em>';
    document.getElementById('modal-body-text').textContent = data.body_text || 'No text body available.';
    let context = data.context;
    if (typeof context === 'string') {
      try { context = JSON.parse(context); } catch (err) { /* keep string */ }
    }
    if (context && typeof context === 'object') {
      document.getElementById('modal-context').textContent = JSON.stringify(context, null, 2);
    } else if (context) {
      document.getElementById('modal-context').textContent = context;
    } else {
      document.getElementById('modal-context').textContent = 'No additional metadata.';
    }
    document.getElementById('email-modal').classList.add('active');
  } catch (error) {
    console.error('Failed to open modal', error);
    alert('Unable to display email details.');
  }
}

function closeEmailModal() {
  document.getElementById('email-modal').classList.remove('active');
}

document.getElementById('email-modal').addEventListener('click', function(evt) {
  if (evt.target === this) {
    closeEmailModal();
  }
});

function checkFollowUps() {
  fetch('/admin/email/check_followups', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
      if (data.status) {
        alert('Follow-up check completed successfully!');
        location.reload();
      } else {
        alert('Error checking follow-ups: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => alert('Error: ' + error));
}
</script>
{% endblock %}
